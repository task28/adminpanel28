<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - Salary Manager</title>
    <style>
        body { background: #111; color: white; font-family: monospace; padding: 20px; }
        h1 { color: #ffd700; border-bottom: 1px solid #333; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #444; }
        th, td { border: 1px solid #444; padding: 10px; text-align: left; vertical-align: top; }
        th { background: #222; color: #ffd700; }
        .btn { padding: 5px 10px; cursor: pointer; border: none; border-radius: 3px; font-weight: bold; margin-right: 5px; margin-top: 5px;}
        .btn-approve { background: #2ecc71; color: #fff; }
        .btn-pay { background: #ffd700; color: #000; }
        .btn-reject { background: #e74c3c; color: #fff; } /* Red Color for Cancel/Reject */
        .stat-badge { background: #333; padding: 3px 6px; border-radius: 4px; font-size: 0.85rem; }
        .stat-badge b { color: #00d2ff; }
    </style>
</head>
<body>
    <h1>Salary Manager (Month: <span id="mName">...</span>)</h1>

    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Target Plan</th>
                <th>Progress (From Start Date)</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="reqTable"></tbody>
    </table>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyB2YLhAvSF12ZZx7LSnbqcCjtS2_8QLt4o", authDomain: "task-f6078.firebaseapp.com", databaseURL: "https://task-f6078-default-rtdb.firebaseio.com", projectId: "task-f6078", storageBucket: "task-f6078.firebasestorage.app", messagingSenderId: "887907470692", appId: "1:887907470692:web:c4142ac9573e19d29d3e71" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const dateObj = new Date();
        const currentMonth = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
        document.getElementById('mName').innerText = currentMonth;

        onValue(ref(db, 'users'), (snap) => {
            const table = document.getElementById('reqTable');
            table.innerHTML = "";
            
            snap.forEach(child => {
                const uid = child.key;
                const u = child.val();

                if (u.salaryTarget && u.salaryTarget.month === currentMonth) {
                    const t = u.salaryTarget;
                    
                    // --- CALCULATE REAL-TIME STATS ---
                    const startTime = t.startDate || 0; 
                    let validRef = 0;
                    let validTasks = 0;

                    if (t.status === 'active' || t.status === 'claimable') {
                        snap.forEach(sub => {
                            const subUser = sub.val();
                            const joinTime = subUser.joinedAt || 0;
                            if(subUser.referredBy === u.referralCode && joinTime >= startTime) {
                                validRef++;
                                validTasks += (subUser.tasksCompleted || 0);
                            }
                        });
                    } else {
                        validRef = 0;
                        validTasks = 0;
                    }

                    // --- ACTIONS ---
                    let statusColor = "white";
                    let actionHtml = "";

                    if (t.status === 'pending') {
                        statusColor = "orange";
                        actionHtml = `
                            <button class="btn btn-approve" onclick="approveStart('${uid}')">START TIMER</button>
                            <button class="btn btn-reject" onclick="rejectReq('${uid}')">REJECT</button>
                        `;
                    }
                    else if (t.status === 'active') {
                        statusColor = "#3498db";
                        // ADDED: Cancel button for Active plans
                        actionHtml = `
                            Running... <br>
                            <button class="btn btn-reject" onclick="cancelActivePlan('${uid}')">CANCEL PLAN</button>
                        `;
                    }
                    else if (t.status === 'claimable') {
                        statusColor = "#ffd700";
                        const goalMet = (validRef >= t.reqRefs && validTasks >= t.reqTasks);
                        const btnText = goalMet ? `PAY ${t.amount} TK` : `PAY ANYWAY (Goal not met)`;
                        const btnStyle = goalMet ? 'btn-pay' : 'btn-reject'; 
                        
                        actionHtml = `<button class="btn ${btnStyle}" onclick="payUser('${uid}', ${t.amount}, ${u.balance||0})">${btnText}</button>`;
                    }
                    else if (t.status === 'paid') {
                        statusColor = "#2ecc71";
                        actionHtml = "Paid ✅";
                    }

                    const row = `
                        <tr>
                            <td>${u.name}<br><small>${u.email}</small></td>
                            <td>
                                <b>${t.amount} TK</b><br>
                                Need: ${t.reqRefs} Refs, ${t.reqTasks} Tasks
                            </td>
                            <td>
                                <span class="stat-badge">Refs: <b>${validRef}</b> / ${t.reqRefs}</span><br><br>
                                <span class="stat-badge">Tasks: <b>${validTasks}</b> / ${t.reqTasks}</span>
                            </td>
                            <td style="color:${statusColor}; font-weight:bold;">${t.status.toUpperCase()}</td>
                            <td>${actionHtml}</td>
                        </tr>
                    `;
                    table.innerHTML += row;
                }
            });
        });

        window.approveStart = (uid) => {
            if(!confirm("Start 30-Day Plan? Only NEW referrals from NOW will count.")) return;
            
            const now = Date.now();
            const days30 = 30 * 24 * 60 * 60 * 1000;
            
            update(ref(db, 'users/' + uid + '/salaryTarget'), {
                status: 'active',
                startDate: now, 
                endDate: now + days30
            });
        };

        window.payUser = (uid, amount, oldBal) => {
            if(!confirm("Confirm Payment?")) return;
            const updates = {};
            updates['users/' + uid + '/balance'] = oldBal + amount;
            updates['users/' + uid + '/salaryTarget/status'] = 'paid';
            update(ref(db), updates);
        };

        window.rejectReq = (uid) => {
            if(!confirm("Reject Application?")) return;
            update(ref(db, 'users/' + uid + '/salaryTarget'), null);
        };

        // NEW FUNCTION: Cancel Active Plan
        window.cancelActivePlan = (uid) => {
            if(!confirm("⚠️ WARNING: Are you sure you want to CANCEL this running plan?\n\nThe user's progress will be stopped and reset.")) return;
            // Deleting the salaryTarget node cancels it
            update(ref(db, 'users/' + uid + '/salaryTarget'), null);
        };
    </script>
</body>
</html>
