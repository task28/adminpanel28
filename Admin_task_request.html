<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Task Logic</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDR38gO9SBcE3qcVvFHlpyE5YdEqo0n2XU", authDomain: "task38-f7daa.firebaseapp.com", databaseURL: "https://task38-f7daa-default-rtdb.firebaseio.com", projectId: "task38-f7daa", storageBucket: "task38-f7daa.firebasestorage.app", messagingSenderId: "655282407518", appId: "1:655282407518:web:637dd6ac82b6c5e6018ccf" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
    </script>
    <style>
        body { background: #050505; color: #ccc; font-family: 'Montserrat', sans-serif; padding: 20px; }
        .card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 8px; margin-bottom: 20px;}
        .btn-approve { background: #27ae60; color: #fff; width: 100%; padding: 10px; border: none; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <h2 style="color:#d4af37">ADMIN CONTROL</h2>
    <div id="review_list">Loading Requests...</div>

    <script>
        auth.onAuthStateChanged(user => {
            if(user && user.email === "rafsanvai388@gmail.com") {
                loadReview();
            } else {
                document.body.innerHTML = "ACCESS DENIED";
            }
        });

        function loadReview() {
            db.ref('tasks').orderByChild('status').equalTo('review').on('value', snap => {
                const list = document.getElementById('review_list');
                list.innerHTML = "";
                if(!snap.exists()) { list.innerHTML = "<p>No tasks for review.</p>"; return; }

                snap.forEach(child => {
                    const data = child.val();
                    const uid = child.key;
                    list.innerHTML += `
                        <div class="card">
                            <p style="color:#2980b9">User: ${uid}</p>
                            <p>Email: ${data.userSubmission.email}</p>
                            <input id="pay_${uid}" type="number" value="0.11" style="width:100%; margin-bottom:10px; padding:5px;">
                            <button class="btn-approve" onclick="approveTask('${uid}')">APPROVE & PAY</button>
                        </div>`;
                });
            });
        }

        // --- MAIN LOGIC ---
        function approveTask(workerUid) {
            const payAmount = parseFloat(document.getElementById('pay_'+workerUid).value) || 0;

            if(confirm("Approve Task?")) {
                db.ref('users/' + workerUid).once('value', snapshot => {
                    if(snapshot.exists()) {
                        const workerData = snapshot.val();

                        // ১. যে কাজ করেছে তার ব্যালেন্স অ্যাড হবে (কিন্তু তার টাস্ক কাউন্ট বাড়বে না টার্গেটে)
                        const newBal = (parseFloat(workerData.balance) || 0) + payAmount;
                        
                        db.ref('users/' + workerUid).update({
                            balance: newBal,
                            totalTasksDone: (workerData.totalTasksDone || 0) + 1
                        }).then(() => {
                            
                            // ২. আপলাইন (Upline) কে খোঁজা এবং কমিশন + টাস্ক টার্গেট আপডেট করা
                            if (workerData.referredBy && workerData.referredBy !== 'none') {
                                sendCommissionToUpline(workerData.referredBy, payAmount);
                            }

                            // ৩. টাস্ক কমপ্লিট করা
                            db.ref('tasks/' + workerUid).update({ status: 'completed' });
                            alert("Task Approved & Commission Sent!");
                        });
                    }
                });
            }
        }

        function sendCommissionToUpline(refCode, taskAmount) {
            // কমিশন ২০% (আপনার ইচ্ছা মত চেঞ্জ করতে পারেন)
            const commission = taskAmount * 0.20; 

            db.ref('users').orderByChild('myRefCode').equalTo(refCode).once('value', snap => {
                snap.forEach(u => {
                    const uplineUid = u.key;
                    const upData = u.val();

                    let updates = {};

                    // A. ব্যালেন্স এবং টুডে কমিশন আপডেট (লিডারবোর্ডের জন্য)
                    updates['balance'] = (parseFloat(upData.balance) || 0) + commission;
                    updates['todayCommission'] = (parseFloat(upData.todayCommission) || 0) + commission; // For Leaderboard
                    updates['totalProfit'] = (parseFloat(upData.totalProfit) || 0) + commission;

                    // B. কন্ডিশন: কমিশন পেলে টাস্ক কাউন্ট বাড়বে (Monthly/Weekly Plans)
                    if (upData.activePlan) {
                        const currentPlanTasks = (upData.activePlan.currentTask || 0) + 1; // +1 Task added
                        updates['activePlan/currentTask'] = currentPlanTasks;
                        console.log("Upline Task Target Increased!");
                    }

                    // ডাটাবেসে আপডেট পাঠানো
                    db.ref('users/' + uplineUid).update(updates);
                });
            });
        }
    </script>
</body>
</html>
