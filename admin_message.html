<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scheduled Message</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { background: #111; color: white; font-family: 'Poppins', sans-serif; padding: 20px; }
        h2 { text-align: center; color: #00c6ff; margin-bottom: 20px; text-transform: uppercase; }

        .container {
            background: #1a1a1a; padding: 30px; border-radius: 15px;
            border: 1px solid #333; max-width: 500px; margin: 0 auto;
            text-align: center; box-shadow: 0 0 20px rgba(0, 198, 255, 0.1);
        }

        select, textarea, input {
            width: 100%; padding: 12px; margin: 8px 0; background: #0f0f0f;
            border: 1px solid #444; border-radius: 8px; color: white;
            box-sizing: border-box; outline: none; font-family: 'Poppins', sans-serif;
            font-size: 14px;
        }
        select:focus, textarea:focus, input:focus { border-color: #00c6ff; }
        textarea { height: 100px; resize: none; }

        .btn-send {
            width: 100%; padding: 12px; background: linear-gradient(45deg, #00c6ff, #0072ff);
            border: none; border-radius: 8px; color: white; font-weight: bold;
            cursor: pointer; margin-top: 10px; transition: 0.3s;
        }
        .btn-stop {
            width: 100%; padding: 12px; background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border: none; border-radius: 8px; color: white; font-weight: bold;
            cursor: pointer; margin-top: 10px; display: none;
        }

        .schedule-box {
            background: rgba(0, 198, 255, 0.1); padding: 15px;
            border-radius: 10px; margin: 15px 0; border: 1px solid rgba(0, 198, 255, 0.3);
            text-align: left;
        }
        .row { display: flex; gap: 10px; }
        
        .status-msg { margin-top: 15px; font-size: 13px; color: #00c6ff; font-weight: bold; }
        .warning { font-size: 11px; color: #aaa; margin-top: 5px; }

        /* Custom Checkbox */
        .check-container { display: block; position: relative; padding-left: 30px; margin-bottom: 12px; cursor: pointer; font-size: 14px; user-select: none; text-align: left; }
        .check-container input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        .checkmark { position: absolute; top: 0; left: 0; height: 20px; width: 20px; background-color: #333; border-radius: 4px; }
        .check-container:hover input ~ .checkmark { background-color: #444; }
        .check-container input:checked ~ .checkmark { background-color: #00c6ff; }
        .checkmark:after { content: ""; position: absolute; display: none; }
        .check-container input:checked ~ .checkmark:after { display: block; }
        .check-container .checkmark:after { left: 7px; top: 3px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
    </style>
</head>
<body>

    <button style="background:#333; color:white; border:none; padding:10px 20px; cursor:pointer; border-radius:5px; margin-bottom:20px;" onclick="window.location.href='admin_home.html'"><i class="fas fa-arrow-left"></i> Back</button>
    <h2>Send Message</h2>

    <div class="container">
        <h3>Compose Notification</h3>
        
        <!-- RECIPIENT -->
        <label style="float:left; font-size:12px; color:#aaa;">Select Recipient:</label>
        <select id="recipientSelect">
            <option value="ALL">üì¢ Send to ALL USERS</option>
            <option disabled>--------------------</option>
            <option disabled>Loading users...</option>
        </select>

        <!-- MESSAGE -->
        <textarea id="msgBody" placeholder="Write your message here..."></textarea>
        
        <!-- SCHEDULE TOGGLE -->
        <label class="check-container">Enable Auto-Schedule
            <input type="checkbox" id="scheduleCheck" onchange="toggleSchedule()">
            <span class="checkmark"></span>
        </label>

        <!-- SCHEDULE SETTINGS -->
        <div id="scheduleOptions" class="schedule-box" style="display:none;">
            <div class="row">
                <div style="flex:1;">
                    <label style="font-size:12px;">Interval (Minutes)</label>
                    <input type="number" id="intervalMin" value="30" placeholder="Min">
                </div>
                <div style="flex:1;">
                    <label style="font-size:12px;">Total Repeat Times</label>
                    <input type="number" id="repeatCount" value="15" placeholder="Count">
                </div>
            </div>
            <p class="warning">‚ö†Ô∏è Keep this window OPEN while scheduling is running.</p>
        </div>
        
        <button id="sendBtn" class="btn-send" onclick="startSending()"><i class="fas fa-paper-plane"></i> SEND / START</button>
        <button id="stopBtn" class="btn-stop" onclick="stopSending()">STOP SCHEDULE</button>
        
        <div id="status" class="status-msg"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAvTnq3h4SAsgOZcKg58TioELMZWr-Jp4c", authDomain: "task-d0f72.firebaseapp.com", databaseURL: "https://task-d0f72-default-rtdb.firebaseio.com", projectId: "task-d0f72", storageBucket: "task-d0f72.firebasestorage.app", messagingSenderId: "376760667912", appId: "1:376760667912:web:056595289880d291d5a6bd" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global Variables for Scheduler
        let timer = null;
        let countSent = 0;
        let maxCount = 0;
        let isScheduled = false;

        // 1. Load Users
        onValue(ref(db, 'users'), (snap) => {
            const selectBox = document.getElementById('recipientSelect');
            let optionsHTML = `<option value="ALL" style="font-weight:bold; color:#00c6ff;">üì¢ Send to ALL USERS</option><option disabled>--------------------</option>`;
            if(snap.exists()){
                snap.forEach(child => {
                    const u = child.val();
                    optionsHTML += `<option value="${child.key}">${u.username} (${u.phone || 'No Phone'})</option>`;
                });
            }
            selectBox.innerHTML = optionsHTML;
        });

        // Toggle UI
        window.toggleSchedule = () => {
            const isChecked = document.getElementById('scheduleCheck').checked;
            document.getElementById('scheduleOptions').style.display = isChecked ? 'block' : 'none';
        }

        // 2. MAIN SENDING FUNCTION
        window.startSending = () => {
            const recipient = document.getElementById('recipientSelect').value;
            const msg = document.getElementById('msgBody').value.trim();
            const useSchedule = document.getElementById('scheduleCheck').checked;

            if(!msg) return alert("Write a message first!");

            // If Schedule is ON
            if(useSchedule) {
                const interval = parseInt(document.getElementById('intervalMin').value);
                maxCount = parseInt(document.getElementById('repeatCount').value);

                if(!interval || !maxCount) return alert("Please set interval and count!");

                // UI Update
                document.getElementById('sendBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';
                document.getElementById('msgBody').disabled = true;
                
                countSent = 0;
                isScheduled = true;

                // Send 1st immediately
                processMessage(recipient, msg);
                
                // Start Loop
                timer = setInterval(() => {
                    if(countSent >= maxCount) {
                        stopSending();
                    } else {
                        processMessage(recipient, msg);
                    }
                }, interval * 60 * 1000); // Minutes to MS

            } else {
                // One time send
                processMessage(recipient, msg);
            }
        }

        // 3. Stop Function
        window.stopSending = () => {
            clearInterval(timer);
            isScheduled = false;
            document.getElementById('status').innerText = "‚èπÔ∏è Schedule Stopped/Finished.";
            document.getElementById('sendBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('msgBody').disabled = false;
        }

        // 4. Core Message Logic
        function processMessage(recipient, msg) {
            const msgData = {
                message: msg,
                date: new Date().toLocaleString(),
                isRead: false,
                from: "Admin"
            };

            const statusBox = document.getElementById('status');
            
            // Logic for ALL vs Single
            if (recipient === "ALL") {
                get(ref(db, 'users')).then((snapshot) => {
                    if (snapshot.exists()) {
                        snapshot.forEach((userSnap) => {
                            push(ref(db, `users/${userSnap.key}/notifications`), msgData);
                        });
                        handlePostSend(true);
                    }
                });
            } else {
                push(ref(db, `users/${recipient}/notifications`), msgData)
                    .then(() => handlePostSend(false));
            }

            function handlePostSend(isAll) {
                if(isScheduled) {
                    countSent++;
                    const timeLeft = document.getElementById('intervalMin').value;
                    statusBox.innerHTML = `‚úÖ Sent Batch: ${countSent} / ${maxCount}<br><span style="color:#aaa; font-weight:normal;">Next message in ${timeLeft} minutes... (DO NOT CLOSE)</span>`;
                    
                    if(countSent >= maxCount) stopSending();
                } else {
                    alert("Message Sent!");
                    document.getElementById('msgBody').value = '';
                }
            }
        }
    </script>
</body>
</html>
