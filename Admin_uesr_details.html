<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - User Database</title>

    <!-- Google Fonts & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDuxSz3j5xMYDw5U9kLA0cjkpOE82D06MI",
            authDomain: "part-1-f6d87.firebaseapp.com",
            databaseURL: "https://part-1-f6d87-default-rtdb.firebaseio.com",
            projectId: "part-1-f6d87",
            storageBucket: "part-1-f6d87.firebasestorage.app",
            messagingSenderId: "682699403122",
            appId: "1:682699403122:web:038ffca84d489a6c0db7eb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
    </script>

    <style>
        * { box-sizing: border-box; }
        body { background-color: #050505; color: #fff; font-family: 'Montserrat', sans-serif; padding: 20px; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #d4af37; padding-bottom: 15px; margin-bottom: 20px; }
        .title { color: #d4af37; font-family: 'Share Tech Mono', monospace; font-size: 1.5rem; }
        .back-btn { background: #333; color: #fff; border: none; padding: 8px 15px; cursor: pointer; }

        /* Stats & Search */
        .top-bar {
            background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333;
            margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; justify-content: space-between;
        }
        .total-badge {
            font-size: 1.2rem; font-family: 'Share Tech Mono'; color: #d4af37;
        }

        .search-box {
            display: flex; background: #000; border: 1px solid #444; border-radius: 5px; overflow: hidden;
        }
        .search-box input {
            background: transparent; border: none; padding: 10px; color: #fff; width: 250px; outline: none;
        }
        .search-box button {
            background: #d4af37; color: #000; border: none; padding: 0 15px; cursor: pointer;
        }

        /* User Grid */
        .user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px; }

        .user-card {
            background: #0f0f0f; border: 1px solid #333; padding: 15px; border-radius: 8px;
            position: relative; transition: 0.2s;
        }
        .user-card:hover { border-color: #d4af37; }

        .u-header {
            display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.8rem; color: #888; border-bottom: 1px solid #222; padding-bottom: 5px;
        }
        .u-name { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .u-email { font-size: 0.9rem; color: #aaa; margin-bottom: 10px; word-break: break-all; }
        
        .u-stats {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 15px;
            background: #1a1a1a; padding: 10px; border-radius: 5px;
        }
        .stat-item { font-size: 0.8rem; color: #ccc; }
        .stat-item span { color: #d4af37; font-weight: bold; }

        .action-row {
            display: flex; gap: 10px; align-items: center;
        }
        .edit-input {
            width: 80px; padding: 5px; background: #000; border: 1px solid #444; color: #fff; text-align: center;
        }
        .btn-save {
            background: #27ae60; color: white; border: none; padding: 6px 10px; cursor: pointer; font-size: 0.8rem; border-radius: 3px;
        }
        .btn-delete {
            background: #c0392b; color: white; border: none; padding: 6px 10px; cursor: pointer; font-size: 0.8rem; border-radius: 3px; margin-left: auto;
        }

        /* --- PAGINATION CSS --- */
        .pagination-container {
            display: flex; justify-content: center; align-items: center; gap: 5px;
            margin-top: 20px; flex-wrap: wrap; padding-bottom: 20px;
        }
        .page-btn {
            background: #111; border: 1px solid #333; color: #fff;
            padding: 8px 12px; cursor: pointer; border-radius: 4px;
            font-family: 'Share Tech Mono', monospace; transition: 0.3s;
        }
        .page-btn:hover { background: #333; border-color: #d4af37; }
        .page-btn.active { background: #d4af37; color: #000; font-weight: bold; border-color: #d4af37; }
        .page-dots { color: #666; padding: 0 5px; }

    </style>
</head>
<body>

    <div class="header">
        <div class="title">USER DATABASE</div>
        <button class="back-btn" onclick="window.location.href='Admin_home.html'">BACK</button>
    </div>

    <div class="top-bar">
        <div class="total-badge">
            TOTAL USERS: <span id="totalCount">0</span>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search Name, Email or UID..." onkeyup="filterUsers()">
            <button><i class="fas fa-search"></i></button>
        </div>
    </div>

    <div id="loading" style="text-align:center; color:#666; margin-top:50px;">
        <i class="fas fa-spinner fa-spin"></i> Loading Database...
    </div>

    <!-- User Grid -->
    <div class="user-grid" id="userList"></div>

    <!-- Pagination Controls -->
    <div class="pagination-container" id="pagination"></div>

    <script>
        let allUsers = [];      // সব ডাটা এখানে থাকবে
        let currentUsers = [];  // সার্চ বা ফিল্টার করার পর ডাটা এখানে থাকবে
        
        // --- PAGINATION SETTINGS ---
        let currentPage = 1;
        const rowsPerPage = 10; // প্রতি পেজে ১০ জন

        // --- AUTH CHECK ---
        const sessionAuth = sessionStorage.getItem("admin_access");

        if (sessionAuth === "granted") {
            fetchAllUsers();
        } else {
            auth.onAuthStateChanged(user => {
                if(user && user.email === "rafsanvai388@gmail.com") {
                    fetchAllUsers();
                } else {
                    fetchAllUsers(); 
                }
            });
        }

        function fetchAllUsers() {
            db.ref('users').on('value', snap => {
                allUsers = [];
                const loadingDiv = document.getElementById('loading');
                if(loadingDiv) loadingDiv.style.display = 'none';
                
                if(snap.exists()) {
                    snap.forEach(child => {
                        let userObj = child.val();
                        userObj.uid = child.key; 
                        allUsers.push(userObj);
                    });
                    
                    // নতুন ডাটা আসলে প্রথমে রিভার্স করে নিচ্ছি (Newest First)
                    allUsers.reverse();

                    // শুরুতে currentUsers এ সব ডাটা দিয়ে দিব
                    currentUsers = [...allUsers];
                    
                    document.getElementById('totalCount').innerText = allUsers.length;
                    
                    // প্রথম পেজ লোড করো
                    displayPage(1);
                } else {
                    document.getElementById('userList').innerHTML = "<p style='text-align:center; color:#444;'>No users found.</p>";
                    document.getElementById('pagination').innerHTML = "";
                }
            });
        }

        // --- PAGINATION LOGIC ---
        function displayPage(page) {
            const list = document.getElementById('userList');
            const pagination = document.getElementById('pagination');
            
            currentPage = page;
            
            // ক্যালকুলেশন
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedItems = currentUsers.slice(start, end);

            // ইউজার রেন্ডার
            list.innerHTML = "";
            if(paginatedItems.length === 0) {
                list.innerHTML = "<p style='text-align:center; width:100%;'>No match found.</p>";
                pagination.innerHTML = "";
                return;
            }
            renderUsers(paginatedItems);

            // বাটন সেটআপ
            setupPagination(currentUsers.length, pagination);
        }

        function setupPagination(totalItems, wrapper) {
            wrapper.innerHTML = "";
            let pageCount = Math.ceil(totalItems / rowsPerPage);
            
            if(pageCount < 2) return; // ১ পেজ হলে বাটনের দরকার নেই

            // Helper function to create button
            function createBtn(text, pageNum, isActive = false) {
                let btn = document.createElement('button');
                btn.innerText = text;
                btn.className = isActive ? 'page-btn active' : 'page-btn';
                btn.onclick = function() { displayPage(pageNum); };
                return btn;
            }

            // Logic for "1 2 ... 5 6 7 ... 100 Next"
            // Prev Button
            if(currentPage > 1) {
                wrapper.appendChild(createBtn("<< Prev", currentPage - 1));
            }

            // Page Numbers Logic
            if (pageCount <= 7) {
                // পেজ কম হলে সব দেখাও
                for (let i = 1; i <= pageCount; i++) {
                    wrapper.appendChild(createBtn(i, i, currentPage == i));
                }
            } else {
                // পেজ অনেক বেশি হলে ডট (...) সিস্টেম
                let pagesToShow = [1, pageCount]; // Always show first and last
                let start = Math.max(2, currentPage - 1);
                let end = Math.min(pageCount - 1, currentPage + 1);

                for(let i = start; i <= end; i++) {
                    pagesToShow.push(i);
                }
                
                pagesToShow = [...new Set(pagesToShow)].sort((a,b)=>a-b); // Sort and unique

                let prev = 0;
                for (let i of pagesToShow) {
                    if (prev > 0 && i - prev > 1) {
                        let span = document.createElement('span');
                        span.className = "page-dots";
                        span.innerText = "...";
                        wrapper.appendChild(span);
                    }
                    wrapper.appendChild(createBtn(i, i, currentPage == i));
                    prev = i;
                }
            }

            // Next Button
            if(currentPage < pageCount) {
                wrapper.appendChild(createBtn("Next >>", currentPage + 1));
            }
        }

        function renderUsers(usersArray) {
            const list = document.getElementById('userList');
            // Note: list clearing is handled in displayPage now

            usersArray.forEach(u => {
                let plan = u.plan ? u.plan.toUpperCase() : "FREE";
                const refBy = (u.referredBy && u.referredBy !== "none") ? u.referredBy : "Admin";
                const regDate = u.regDate || "N/A";
                const uName = u.name || "Unknown";
                const uEmail = u.email || "No Email";
                const uBalance = u.balance !== undefined ? parseFloat(u.balance) : 0;
                const shortUid = u.uid ? u.uid.substring(0,6) : "ERR";

                // --- PROFIT FIX ---
                let uProfit = 0;
                if (u.totalProfit !== undefined) uProfit = parseFloat(u.totalProfit);
                else if (u.profit !== undefined) uProfit = parseFloat(u.profit);
                else if (u.totalIncome !== undefined) uProfit = parseFloat(u.totalIncome);
                
                if (uProfit === 0 && uBalance > 0) uProfit = uBalance;

                const html = `
                    <div class="user-card">
                        <div class="u-header">
                            <span>UID: ${shortUid}...</span>
                            <span>Join: ${regDate}</span>
                        </div>
                        <div class="u-name">${uName}</div>
                        <div class="u-email">${uEmail}</div>

                        <div class="u-stats">
                            <div class="stat-item">Team: <span>${u.teamCount || 0}</span></div>
                            <div class="stat-item">Ref By: <span>${refBy}</span></div>
                            <div class="stat-item">Plan: <span style="color:${plan==='FREE'?'#aaa':'#d4af37'}">${plan}</span></div>
                            <div class="stat-item">Profit: <span style="color:#2ecc71">$${uProfit.toFixed(2)}</span></div>
                        </div>

                        <div class="action-row">
                            <span style="font-size:0.8rem; color:#aaa;">Balance: $</span>
                            <input type="number" id="bal_${u.uid}" class="edit-input" value="${uBalance}">
                            <button class="btn-save" onclick="updateBalance('${u.uid}')">SAVE</button>
                            <button class="btn-delete" onclick="deleteUser('${u.uid}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        function filterUsers() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            // Filter from the main ALL data
            currentUsers = allUsers.filter(u => {
                const name = u.name ? u.name.toLowerCase() : "";
                const email = u.email ? u.email.toLowerCase() : "";
                const uid = u.uid ? u.uid : "";
                return name.includes(query) || email.includes(query) || uid.includes(query);
            });
            
            // Reset to page 1 after search
            displayPage(1);
        }

        function updateBalance(uid) {
            const newBal = parseFloat(document.getElementById('bal_'+uid).value);
            if(confirm("Update balance to $" + newBal + "?")) {
                db.ref('users/' + uid).update({
                    balance: newBal
                }).then(() => alert("Balance Updated!"));
            }
        }

        function deleteUser(uid) {
            if(confirm("Delete this user permanently?")) {
                db.ref('users/' + uid).remove();
                db.ref('tasks/' + uid).remove();
            }
        }
    </script>
</body>
</html>
