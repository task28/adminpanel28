<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Task Manager</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDR38gO9SBcE3qcVvFHlpyE5YdEqo0n2XU", authDomain: "task38-f7daa.firebaseapp.com", databaseURL: "https://task38-f7daa-default-rtdb.firebaseio.com", projectId: "task38-f7daa", storageBucket: "task38-f7daa.firebasestorage.app", messagingSenderId: "655282407518", appId: "1:655282407518:web:637dd6ac82b6c5e6018ccf" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
    </script>
    <style>
        body { background: #050505; color: #ccc; font-family: 'Montserrat', sans-serif; padding: 20px; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #d4af37; padding-bottom: 15px; margin-bottom: 20px; }
        .title { color: #d4af37; font-family: 'Share Tech Mono', monospace; font-size: 1.5rem; }
        .back-btn { background: #333; color: #fff; border: none; padding: 8px 15px; cursor: pointer; }
        
        .section-title { color: #fff; margin: 20px 0 10px; border-left: 4px solid #d4af37; padding-left: 10px; font-weight: bold; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 8px; }
        
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 0.7rem; color: #666; }
        .input-group input { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; }
        
        .data-display { background: #000; padding: 10px; border: 1px dashed #444; margin-bottom: 10px; cursor: pointer; word-break: break-all; }
        
        .btn-action { width: 100%; padding: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-send { background: #d4af37; color: #000; }
        .btn-approve { background: #27ae60; color: #fff; }
        .btn-reject { background: #c0392b; color: #fff; }
        .profit-input { width: 100%; padding: 8px; margin-bottom: 5px; background: #222; border: 1px solid #27ae60; color: #fff; text-align: center; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">TASK MANAGER</div>
        <button class="back-btn" onclick="window.location.href='Admin_home.html'">BACK</button>
    </div>

    <div class="section-title">PENDING REQUESTS</div>
    <div class="grid-container" id="pending_list">Loading...</div>

    <div class="section-title">SUBMITTED FOR REVIEW</div>
    <div class="grid-container" id="review_list">Loading...</div>

    <script>
        auth.onAuthStateChanged(user => {
            if(!user || user.email !== "rafsanvai388@gmail.com") window.location.href = "Admin_login.html";
            else { loadPending(); loadReview(); }
        });

        // 1. PENDING
        function loadPending() {
            db.ref('tasks').orderByChild('status').equalTo('pending').on('value', snap => {
                const list = document.getElementById('pending_list');
                list.innerHTML = "";
                if(!snap.exists()) { list.innerHTML = "<p>No pending requests.</p>"; return; }

                snap.forEach(child => {
                    const uid = child.key;
                    const randPass = "Pass" + Math.floor(Math.random()*10000);
                    list.innerHTML += `
                        <div class="card">
                            <div style="color:#d4af37; margin-bottom:10px;">UID: ${uid.substring(0,6)}...</div>
                            <div class="input-group"><label>First Name</label><input id="fn_${uid}" placeholder="John"></div>
                            <div class="input-group"><label>Last Name</label><input id="ln_${uid}" placeholder="Doe"></div>
                            <div class="input-group"><label>DOB</label><input id="dob_${uid}" placeholder="01/01/1990"></div>
                            <div class="input-group"><label>Recovery</label><input id="rec_${uid}" placeholder="rec@gmail.com"></div>
                            <div class="input-group"><label>Pass</label><input id="pass_${uid}" value="${randPass}"></div>
                            <button class="btn-action btn-send" onclick="sendData('${uid}')">SEND DATA</button>
                        </div>`;
                });
            });
        }

        function sendData(uid) {
            const adminData = {
                fname: document.getElementById('fn_'+uid).value || "User",
                lname: document.getElementById('ln_'+uid).value || "Name",
                dob: document.getElementById('dob_'+uid).value || "01/01/2000",
                recovery: document.getElementById('rec_'+uid).value || "none",
                pass: document.getElementById('pass_'+uid).value || "123456"
            };
            db.ref('tasks/' + uid).update({ status: 'active', adminData: adminData, startTime: Date.now() });
        }

        // 2. REVIEW
        function loadReview() {
            db.ref('tasks').orderByChild('status').equalTo('review').on('value', snap => {
                const list = document.getElementById('review_list');
                list.innerHTML = "";
                if(!snap.exists()) { list.innerHTML = "<p>No submissions.</p>"; return; }

                snap.forEach(child => {
                    const data = child.val();
                    const uid = child.key;
                    const email = data.userSubmission ? data.userSubmission.email : "Error";
                    const pass = data.userSubmission ? data.userSubmission.pass : "Error";

                    list.innerHTML += `
                        <div class="card" style="border-color: #2980b9;">
                            <div style="color:#2980b9; margin-bottom:10px;">SUBMISSION: ${uid.substring(0,6)}...</div>
                            <div class="data-display" onclick="copy('${email}')">Email: ${email}</div>
                            <div class="data-display" onclick="copy('${pass}')">Pass: ${pass}</div>
                            <div style="margin-top:10px;">
                                <input id="pay_${uid}" type="number" class="profit-input" value="0.11">
                                <button class="btn-action btn-approve" onclick="approveTask('${uid}')">APPROVE</button>
                                <button class="btn-action btn-reject" onclick="rejectTask('${uid}')">REJECT</button>
                            </div>
                        </div>`;
                });
            });
        }

        function copy(t) { navigator.clipboard.writeText(t); alert("Copied!"); }

        // --- MAIN LOGIC UPDATE (COMMISSION & TARGETS) ---
        function approveTask(uid) {
            const payAmount = parseFloat(document.getElementById('pay_'+uid).value) || 0;

            if(confirm(`Approve? User gets $${payAmount}`)) {
                // 1. Get User Data
                db.ref('users/' + uid).once('value', snapshot => {
                    if(snapshot.exists()) {
                        const userData = snapshot.val();
                        
                        // User Stats Update
                        const newBal = (parseFloat(userData.balance) || 0) + payAmount;
                        const newTotal = (parseFloat(userData.totalProfit) || 0) + payAmount;
                        const tasksDone = (userData.totalTasksDone || 0) + 1;

                        // 2. Update Worker (The User who did the task)
                        let userUpdates = {
                            balance: newBal,
                            totalProfit: newTotal,
                            totalTasksDone: tasksDone,
                            todayProfit: (parseFloat(userData.todayProfit)||0) + payAmount
                        };

                        // 3. Update Worker's OWN Active Plan (Task Count)
                        if(userData.activePlan) {
                            userUpdates['activePlan/currentTask'] = (userData.activePlan.currentTask || 0) + 1;
                        }

                        db.ref('users/' + uid).update(userUpdates).then(() => {
                            
                            // 4. HANDLE UPLINE (Referrer Logic)
                            if (userData.referredBy && userData.referredBy !== 'none') {
                                handleUplineRewards(userData.referredBy, payAmount, tasksDone);
                            }

                            // 5. Close Task
                            db.ref('tasks/' + uid).update({ status: 'completed' });
                            alert("Task Approved!");
                        });
                    } else {
                        if(confirm("User not found! Delete task?")) db.ref('tasks/' + uid).remove();
                    }
                });
            }
        }

        // Function to Handle Commission & Target for Upline
        function handleUplineRewards(refCode, payAmount, workerTotalTasks) {
            db.ref('users').orderByChild('myRefCode').equalTo(refCode).once('value', snap => {
                if(snap.exists()) {
                    snap.forEach(u => {
                        const upUid = u.key;
                        const upData = u.val();
                        
                        let updates = {};

                        // A. 20% COMMISSION Logic
                        const comm = payAmount * 0.20;
                        updates['balance'] = (parseFloat(upData.balance) || 0) + comm;
                        updates['totalProfit'] = (parseFloat(upData.totalProfit) || 0) + comm;

                        // B. TARGET UPDATE Logic (If Upline has an Active Plan)
                        if (upData.activePlan) {
                            // 1. Task Count: Downline did a task -> Upline's Task Target increases
                            // "tar target oikhane o 2 task add hobe" (Assuming 1 task done = 1 count added)
                            const currentTaskCount = (upData.activePlan.currentTask || 0) + 1;
                            updates['activePlan/currentTask'] = currentTaskCount;

                            // 2. Referral Count: Only if Worker finished exactly 2 tasks
                            if (workerTotalTasks === 2) {
                                const currentRefCount = (upData.activePlan.currentRef || 0) + 1;
                                updates['activePlan/currentRef'] = currentRefCount;
                            }
                        }

                        // Apply Updates to Upline
                        db.ref('users/' + upUid).update(updates);
                    });
                }
            });
        }

        function rejectTask(uid) {
            if(confirm("Reject?")) db.ref('tasks/' + uid).update({ status: 'rejected' });
        }
    </script>
</body>
</html>
