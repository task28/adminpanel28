<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin - User Manager & Gifts</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDuxSz3j5xMYDw5U9kLA0cjkpOE82D06MI",
            authDomain: "part-1-f6d87.firebaseapp.com",
            databaseURL: "https://part-1-f6d87-default-rtdb.firebaseio.com",
            projectId: "part-1-f6d87",
            storageBucket: "part-1-f6d87.firebasestorage.app",
            messagingSenderId: "682699403122",
            appId: "1:682699403122:web:038ffca84d489a6c0db7eb"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
    </script>

    <style>
        body { background: #050505; color: #fff; font-family: 'Montserrat', sans-serif; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #d4af37; padding-bottom: 15px; margin-bottom: 20px; }
        .title { color: #d4af37; font-family: 'Share Tech Mono', monospace; font-size: 1.5rem; }
        .back-btn { background: #333; color: #fff; border: none; padding: 8px 15px; cursor: pointer; }

        /* SEARCH BOX */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-inp { flex: 1; padding: 12px; background: #111; border: 1px solid #444; color: #fff; }
        .search-btn { background: #d4af37; border: none; padding: 0 20px; font-weight: bold; cursor: pointer; }

        /* USER CARD */
        .user-card { 
            background: #111; border: 1px solid #333; padding: 20px; border-radius: 8px; 
            margin-bottom: 20px; display: none; 
        }
        .uc-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .uc-info h3 { margin: 0; color: #2ecc71; }
        .uc-info p { font-size: 0.8rem; color: #888; }

        /* GIFT FORM */
        .gift-section { background: rgba(212, 175, 55, 0.1); padding: 15px; border-radius: 8px; border: 1px dashed #d4af37; }
        .gift-inp { width: 100%; padding: 10px; margin-bottom: 10px; background: #000; border: 1px solid #555; color: #fff; }
        .btn-gift { width: 100%; padding: 12px; background: #d4af37; border: none; font-weight: bold; cursor: pointer; }

        /* HISTORY LOG */
        .history-log { margin-top: 20px; }
        .log-item { background: #080808; padding: 10px; border-bottom: 1px solid #222; font-size: 0.85rem; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="header">
        <div class="title">ADMIN - USER & GIFT</div>
        <button class="back-btn" onclick="window.location.href='Admin_home.html'">BACK</button>
    </div>

    <div class="search-box">
        <input type="text" id="searchUid" class="search-inp" placeholder="Paste User UID here...">
        <button class="search-btn" onclick="searchUser()">SEARCH</button>
    </div>

    <!-- USER DETAILS CARD -->
    <div id="userCard" class="user-card">
        <div class="uc-header">
            <div class="uc-info">
                <h3 id="uName">User Name</h3>
                <p id="uEmail">email@example.com</p>
                <p>UID: <span id="uUid">...</span></p>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.5rem; color: #d4af37; font-weight: bold;">$<span id="uBal">0.00</span></div>
                <div style="font-size: 0.7rem; color: #888;">Current Balance</div>
            </div>
        </div>

        <!-- GIFT SENDER -->
        <div class="gift-section">
            <h4 style="color:#d4af37; margin-bottom:10px;"><i class="fas fa-gift"></i> SEND GIFT / BONUS</h4>
            <input type="number" id="giftAmount" class="gift-inp" placeholder="Amount (e.g., 5.00)">
            <input type="text" id="giftMsg" class="gift-inp" placeholder="Reason (e.g., Good Work, Weekly Bonus)">
            <button class="btn-gift" onclick="sendGift()">SEND MONEY & NOTIFY</button>
        </div>

        <!-- USER HISTORY -->
        <h4 style="margin-top:20px; border-bottom:1px solid #333; padding-bottom:5px;">USER TRANSACTION HISTORY (Last 10)</h4>
        <div class="history-log" id="logList">
            <!-- Logs load here -->
        </div>
    </div>

    <script>
        let currentTargetUid = null;

        // AUTH CHECK
        auth.onAuthStateChanged(user => {
            if(!user || user.email !== "rafsanvai388@gmail.com") {
                window.location.href = "index.html";
            }
        });

        function searchUser() {
            const uid = document.getElementById('searchUid').value.trim();
            if(!uid) return alert("Enter UID");

            db.ref('users/' + uid).once('value', snap => {
                if(snap.exists()) {
                    const data = snap.val();
                    currentTargetUid = uid;
                    
                    document.getElementById('userCard').style.display = 'block';
                    document.getElementById('uName').innerText = data.name;
                    document.getElementById('uEmail').innerText = data.email;
                    document.getElementById('uUid').innerText = uid;
                    document.getElementById('uBal').innerText = parseFloat(data.balance || 0).toFixed(4);
                    
                    loadUserHistory(uid);
                } else {
                    alert("User not found!");
                    document.getElementById('userCard').style.display = 'none';
                }
            });
        }

        // SEND GIFT LOGIC
        function sendGift() {
            if(!currentTargetUid) return;
            const amount = parseFloat(document.getElementById('giftAmount').value);
            const msg = document.getElementById('giftMsg').value || "Admin Bonus";

            if(!amount || amount <= 0) return alert("Invalid Amount");

            if(confirm(`Send $${amount} to this user?`)) {
                db.ref('users/' + currentTargetUid).once('value', snap => {
                    const u = snap.val();
                    const newBal = (parseFloat(u.balance || 0) + amount).toFixed(4);
                    const newLife = (parseFloat(u.totalEarnings || 0) + amount).toFixed(4);

                    // 1. Update User Balance & Lifetime
                    db.ref('users/' + currentTargetUid).update({
                        balance: newBal,
                        totalEarnings: newLife
                    });

                    // 2. Add to History
                    const histData = {
                        type: 'gift',
                        amount: amount,
                        desc: msg,
                        date: Date.now()
                    };
                    db.ref('history/' + currentTargetUid).push(histData);

                    // 3. Clear Inputs
                    document.getElementById('giftAmount').value = "";
                    document.getElementById('giftMsg').value = "";
                    alert("Gift Sent Successfully!");
                    
                    // Refresh
                    searchUser();
                });
            }
        }

        function loadUserHistory(uid) {
            db.ref('history/' + uid).limitToLast(10).on('value', snap => {
                const list = document.getElementById('logList');
                list.innerHTML = "";
                if(!snap.exists()) {
                    list.innerHTML = "<p style='color:#666;'>No history found.</p>";
                    return;
                }

                let items = [];
                snap.forEach(c => items.push(c.val()));
                items.reverse();

                items.forEach(item => {
                    let color = "#2ecc71";
                    let sign = "+";
                    if(item.type === 'withdraw') { color = "#e74c3c"; sign = "-"; }

                    list.innerHTML += `
                        <div class="log-item">
                            <span>${item.desc} (${item.type})</span>
                            <span style="color:${color}; font-weight:bold;">${sign}$${parseFloat(item.amount).toFixed(2)}</span>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
